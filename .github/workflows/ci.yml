name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]

env:
  COMMANDBOX_HOME: ${{ github.workspace }}/.commandbox

jobs:
  test:
    name: Tests - Lucee ${{ matrix.lucee }}
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        lucee: ["5.3", "5.4", "6.0"]
        experimental: [false]
        include:
          - lucee: "6.1"
            experimental: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Setup CommandBox
        uses: Ortus-Solutions/setup-commandbox@v2
        with:
          version: "6.0.0"
          forgeboxAPIKey: ${{ secrets.FORGEBOX_API_KEY }}

      - name: Install Dependencies
        run: box install

      - name: Start Server
        run: |
          box server start cfengine=lucee@${{ matrix.lucee }} --debug
          box server log
          curl -sSf http://127.0.0.1:8080/ || echo "Server warmup..."
          sleep 5

      - name: Run Tests
        run: |
          box testbox run runner="http://127.0.0.1:8080/tests/runner.cfm" outputFormats="json,text" verbose=true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-lucee-${{ matrix.lucee }}
          path: |
            tests/results/**
            .commandbox/server/**/logs/**
          retention-days: 5

      - name: Server Logs on Failure
        if: failure()
        run: |
          echo "=== Server Status ==="
          box server status
          echo ""
          echo "=== Server Log ==="
          box server log
          echo ""
          echo "=== Console Log ==="
          cat .commandbox/server/*/logs/console.log 2>/dev/null || echo "No console log found"

      - name: Stop Server
        if: always()
        run: box server stop

  publish:
    name: Publish to ForgeBox
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup CommandBox
        uses: Ortus-Solutions/setup-commandbox@v2
        with:
          version: "6.0.0"
          forgeboxAPIKey: ${{ secrets.FORGEBOX_API_KEY }}

      - name: Publish to ForgeBox
        run: box publish

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            Automated release from CI pipeline.

            View on ForgeBox: https://forgebox.io/view/qbml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
